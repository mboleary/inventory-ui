<!Doctype html>
<html>
    <head>
        <title>View Entry</title>
        <link rel="stylesheet" type="text/css" href="style/main.css">
        <link rel="stylesheet" type="text/css" href="style/header.css">
        <link rel="stylesheet" type="text/css" href="style/footer.css">
        <link rel="stylesheet" type="text/css" href="style/content.css">
        <link rel="stylesheet" type="text/css" href="style/cards.css">
        <link rel="stylesheet" type="text/css" href="style/article.css">
        <link rel="stylesheet" type="text/css" href="style/misc.css">
        <link rel="stylesheet" type="text/css" href="style/print.css">
        <link rel="stylesheet" type="text/css" href="style/form.css">
        <meta charset="UTF-8">
        <meta name="description" content="Blank Template Page">
        <meta name="author" content="Webtemplate">
        <meta name="generator" content="none">
        <meta name="keywords" content="keywords, go, here">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="theme-color" content="#00121a"> <!-- Colored Chrome Mobile Tabs! -->
        <link rel="icon" type="image/png" href="/favicon.png">
        <script type="module">
            import {assetTableSchema} from "/script/const/formSchema.js";
            // import genTable from "/script/util/table/genTable.js";
            import genForm from "/script/util/form/genForm.js";
            import {getOne, post, put} from "/script/lib/net/asset.js";
            import genCards from "/script/util/card/genCard.js";
            import buildForm from "/script/util/form/buildForm.js";
            import {assetFormSchema} from "/script/const/formSchema.js";

            // get the data, then generate the table
            const form = document.querySelector("#data-form");
            function handleClick (row, event) {
                console.log("Clicked on", row);
                location.href = `${location.origin}/view.html?id=${row.id}`;
            }

            function handleChange(e) {
                // Here is where we would modify other fields in the form if needed
            }

            async function handleSubmit(data, e) {
                // This is where we handle the submit action of the form

                // @TODO Validate the data

                console.log("About to save:", data.id);

                if (!data.id) {
                    await post(data);
                } else {
                    await put(data);
                }

                location.href = `${location.origin}/`;
            }

            // Generate the form

            const formTarget = document.getElementById("elements");
            const flavorText = document.getElementById("flavorText");
            buildForm(assetFormSchema, formTarget);

            const params = (new URL(document.location)).searchParams;

            let id = params.get('id');
            if (id !== null) {
                getOne({id: id}).then(data => {
                    console.log("Got data back:", data);
                    genForm(data, form, handleChange, handleSubmit);

                    const relCards = document.getElementById("relation-cards");
                    const relTemplate = document.getElementById("relation-card");
                    genCards(data.relations, relTemplate, relCards);

                    const imageCards = document.getElementById("image-cards");
                    const imageTemplate = document.getElementById("image-card");

                    genCards(data.images, imageTemplate, imageCards, null, null, (data, content) => {
                        const img = content.querySelector("img");
                        if (data.image_path) {
                            img.src = `http://localhost:8003/${data.image_path}`;
                        } else {
                            img.hidden = true;
                        }
                    });
                }).catch(err => {
                    flavorText.style.color = "red";
                    console.log("Error:", err);
                    if (err && err.message) {
                        flavorText.innerText = err.message;
                    } else {
                        flavorText.innerText = "There was an error getting the entry.";
                    }
                })
            }
        </script>
    </head>
    <body>
        <section class="container">
            <form id="data-form" class="info">
                <div class="head">
                    <h1>Edit Entry</h1>
                </div>
                <div class="body">
                    <p id="flavorText">Edit the inventory item to your liking</p>
                    <div id="elements"></div>
                    <h3 class="accent-3 vbar">Related assets</h3>
                    <div id="relation-cards"></div>
                    <h3 class="accent-3 vbar">Images</h3>
                    <div id="image-cards"></div>
                    <hr>
                    <input type="submit" value="Submit">
                </div>
            </form>
        </section>
        <template id="relation-card">
            <article card-action="click" style="border: 1px solid black">
                <div class="article-header">
                    <h2 name="name"></h2>
                    <p name="type"></p>
                    <p name="acquired_value"></p>
                </div>
                <!-- Setting `type` is important to prevent submitting the form -->
                <button type="button" card-action="delete">Remove</button>
            </article>
        </template>
        <template id="image-card">
            <article card-action="click" style="border: 1px solid black">
                <h2 name="name"></h2>
                <img src="#" loading="lazy">
                <!-- Setting `type` is important to prevent submitting the form -->
                <button type="button" card-action="delete">Remove</button>
            </article>
        </template>
    </body>
</html>